{"version":3,"sources":["../../../../context/RequestsContext.tsx","../../../../app/requests/layout.tsx"],"sourcesContent":["\"use client\";\n\nimport React, { createContext, useContext, useState, useEffect, useCallback } from 'react';\nimport { supabase } from '@/lib/supabase';\nimport type { BloodRequest } from '@/types';\nimport { useAuth } from './AuthContext';\n\ninterface RequestsContextType {\n    requests: BloodRequest[]; // Active requests\n    myDonations: Set<string>; // IDs of requests user has offered to donate to\n    loading: boolean;\n    error: Error | null;\n    refreshRequests: () => Promise<void>;\n}\n\nconst RequestsContext = createContext<RequestsContextType | undefined>(undefined);\n\nexport function RequestsProvider({ children }: { children: React.ReactNode }) {\n    const { user } = useAuth(); // We might need user for RLS, or generally to trigger fetch on auth change\n    const [requests, setRequests] = useState<BloodRequest[]>([]);\n    const [myDonations, setMyDonations] = useState<Set<string>>(new Set());\n    const [loading, setLoading] = useState(true);\n    const [error, setError] = useState<Error | null>(null);\n\n    const fetchRequests = useCallback(async () => {\n        try {\n            setLoading(true);\n            setError(null);\n\n            // Centralized fetch: Only Active requests, newest first\n            const { data, error: supabaseError } = await supabase\n                .from('blood_requests')\n                .select('*')\n                .eq('status', 'active')\n                .order('created_at', { ascending: false });\n\n            if (supabaseError) throw supabaseError;\n\n            setRequests(data as BloodRequest[] || []);\n\n            // Also fetch user's donations if logged in\n            if (user) {\n                const { data: donationData, error: donationError } = await supabase\n                    .from('donations')\n                    .select('request_id')\n                    .eq('donor_id', user.id)\n                    .neq('status', 'cancelled'); // Active offers only\n\n                if (!donationError && donationData) {\n                    setMyDonations(new Set(donationData.map(d => d.request_id)));\n                }\n            } else {\n                setMyDonations(new Set());\n            }\n\n        } catch (err: any) {\n            console.error('Error in RequestsContext:', err);\n            setError(err);\n        } finally {\n            setLoading(false);\n        }\n    }, [user]); // Re-fetch when user changes\n\n    // Fetch on mount or when user changes (e.g. login/logout could change RLS visibility)\n    useEffect(() => {\n        fetchRequests();\n\n        // Optional: Real-time subscription could go here\n        const channel = supabase\n            .channel('public_requests')\n            .on('postgres_changes',\n                { event: '*', schema: 'public', table: 'blood_requests' },\n                () => {\n                    console.log('Real-time update: Refreshing requests...');\n                    fetchRequests();\n                }\n            )\n            .subscribe();\n\n        return () => {\n            supabase.removeChannel(channel);\n        };\n    }, [fetchRequests, user]);\n\n    const value = {\n        requests,\n        myDonations,\n        loading,\n        error,\n        refreshRequests: fetchRequests\n    };\n\n    return <RequestsContext.Provider value={value}>{children}</RequestsContext.Provider>;\n}\n\nexport const useRequests = () => {\n    const context = useContext(RequestsContext);\n    if (context === undefined) {\n        throw new Error('useRequests must be used within a RequestsProvider');\n    }\n    return context;\n};\n","\"use client\";\n\nimport React from 'react';\nimport { RequestsProvider } from '@/context/RequestsContext';\n\nexport default function RequestsLayout({\n    children,\n}: {\n    children: React.ReactNode;\n}) {\n    return (\n        <RequestsProvider>\n            {children}\n        </RequestsProvider>\n    );\n}\n"],"names":[],"mappings":"wDAEA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAEA,EAAA,EAAA,CAAA,CAAA,OAUA,IAAM,EAAkB,CAAA,EAAA,EAAA,aAAA,AAAa,EAAkC,QAEhE,SAAS,EAAiB,UAAE,CAAQ,CAAiC,EACxE,GAAM,MAAE,CAAI,CAAE,CAAG,CAAA,EAAA,EAAA,OAAA,AAAO,IAClB,CADsB,AACrB,EAAU,EAAY,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAiB,EAAE,EACrD,CAAC,EAAa,EAAe,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAc,IAAI,KAC1D,CAAC,EAAS,EAAW,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAHiE,CAGhE,GACjC,CAAC,EAAO,EAAS,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAe,MAE3C,EAAgB,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,UAC9B,GAAI,CACA,EAAW,IACX,EAAS,MAGT,GAAM,MAAE,CAAI,CAAE,MAAO,CAAa,CAAE,CAAG,MAAM,EAAA,QAAQ,CAChD,IAAI,CAAC,kBACL,MAAM,CAAC,KACP,EAAE,CAAC,SAAU,UACb,KAAK,CAAC,aAAc,CAAE,WAAW,CAAM,GAE5C,GAAI,EAAe,MAAM,EAKzB,GAHA,EAAY,GAA0B,EAAE,EAGpC,EAAM,CACN,GAAM,CAAE,KAAM,CAAY,CAAE,MAAO,CAAa,CAAE,CAAG,MAAM,EAAA,QAAQ,CAC9D,IAAI,CAAC,aACL,MAAM,CAAC,cACP,EAAE,CAAC,WAAY,EAAK,EAAE,EACtB,GAAG,CAAC,SAAU,YAEf,EAF6B,AAE5B,GAAiB,GAClB,EAAe,IAAI,IAAI,CADS,CACI,GAHc,AAGX,CAAC,GAAK,EAAE,UAAU,GAEjE,MACI,CADG,CACY,IAAI,IAG3B,CAAE,MAAO,EAAU,CACf,QAAQ,KAAK,CAAC,4BAA6B,GAC3C,EAAS,EACb,QAAU,CACN,GAAW,EACf,CACJ,EAAG,CAAC,EAAK,GAAG,KAGZ,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KACN,GAJqC,CAOrC,IAAM,EAAU,EAAA,QAAQ,CACnB,OAAO,CAAC,mBACR,EAAE,CAAC,mBACA,CAAE,MAAO,IAAK,OAAQ,SAAU,MAAO,gBAAiB,EACxD,KACI,QAAQ,GAAG,CAAC,4CACZ,GACJ,GAEH,SAAS,GAEd,MAAO,KACH,EAAA,QAAQ,CAAC,aAAa,CAAC,EAC3B,CACJ,EAAG,CAAC,EAAe,EAAK,EAUjB,CAAA,EAAA,EAAA,GAAA,EAAC,EAAgB,QAAQ,CAAA,CAAC,MARnB,CAQ0B,SAPpC,cACA,UACA,QACA,EACA,gBAAiB,CACrB,WAEgD,GACpD,+CAE2B,KACvB,IAAM,EAAU,CAAA,EAAA,EAAA,UAAA,AAAU,EAAC,GAC3B,QAAgB,IAAZ,EACA,KADuB,CACjB,AAAI,MAAM,sDAEpB,OAAO,CACX,6CClGA,EAAA,EAAA,CAAA,CAAA,OAEe,SAAS,EAAe,CACnC,UAAQ,CAGX,EACG,MACI,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,gBAAgB,CAAA,UACZ,GAGb"}